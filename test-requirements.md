# Battery Management System 单元测试规范

## 1. 测试组织结构

- 使用 JUnit 5 的嵌套测试类结构 (@Nested)
- 每个控制器对应一个独立嵌套测试类
- 所有测试统一整合在 `ApiControllerTest` 类中
- 测试类和方法使用 @DisplayName 提供描述性注释

## 2. 测试方法命名和结构

- 命名遵循 `test[功能][场景]` 格式，如 `testWarnReportSuccess`
- 测试方法组织按功能进行分组
- 每个测试方法注释需包含方法目的说明
- 测试结构遵循：准备数据 -> 设置mock -> 调用方法 -> 验证结果 -> 验证mock调用

## 3. Mock 和依赖注入

- 使用 MockitoAnnotations.openMocks(this) 初始化所有mock对象
- 服务层使用 @Mock 注解进行模拟
- 控制器使用 @InjectMocks 注解注入模拟依赖
- 每个嵌套测试类必须单独设置 MockMvc 实例

## 4. 测试用例覆盖范围

- **成功路径测试**：验证正常操作流程下的行为
- **异常测试**：验证发生异常时的处理和响应
- **边界条件测试**：验证边界值和特殊情况(如：匹配失败、不报警等)
- **数据转换测试**：验证数据类型转换正确性(如：警告级别转换)
- **过滤逻辑测试**：验证过滤功能的正确性
- **参数验证测试**：验证输入参数验证逻辑

## 5. 断言与验证

- 使用 assertEquals, assertTrue, assertNull 等方法进行断言
- 验证响应状态码、消息和数据内容
- 验证服务方法的调用次数和参数 (verify)
- 针对集合类数据，验证大小和内容结构

## 6. 测试数据准备

- 使用易于识别的测试数据(如固定ID、名称等)
- 对于复杂对象，确保所有必要属性都设置完整
- 为不同场景准备相应的测试数据

## 7. 异常测试要求

- 使用 when().thenThrow() 模拟异常
- 验证异常处理后的响应码(10000)
- 验证错误信息包含原始异常信息
- 验证数据为null

## 8. 代码风格

- 测试代码保持良好的缩进和格式
- 代码块之间使用空行分隔以提高可读性
- 所有中文信息使用UTF-8编码

## 9. 特定业务验证

- 警告级别转换逻辑：高/严重 -> 0, 中/警告 -> 1, 低/提示 -> 2
- 过滤逻辑："匹配失败"和"不报警"的记录不应出现在结果中
- 车辆API响应结构符合预期

此规范用于指导所有后续单元测试的编写，确保测试质量和一致性。 